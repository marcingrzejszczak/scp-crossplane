apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: artifact-to-scp
spec:
  # This is your XR type
  compositeTypeRef:
    apiVersion: platform.example.org/v1alpha1
    kind: CompositeArtifact

  # Your Crossplane build only supports Pipeline (or nil → Pipeline)
  mode: Pipeline

  pipeline:
    - step: patch-and-transform
      functionRef:
        # must match the Function name from examples/function-patch-and-transform.yaml
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          - name: scparticle
            base:
              apiVersion: ops.example.org/v1alpha1
              kind: SCPArtifact
              metadata:
                # This label is what your JUnit test is filtering on:
                # withLabel("crossplane.io/composite", compositeName)
                labels:
                  crossplane.io/composite: $(context.composite.resource.metadata.name)
              spec:
                # placeholders – will be overwritten by patches below
                host: ""
                port: 0
                username: ""
                secretRefName: ""
                destinationPath: ""
                sourceInlineBase64: ""
            patches:
              # host
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.host"
                toFieldPath: "spec.host"

              # port
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.port"
                toFieldPath: "spec.port"

              # username
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.username"
                toFieldPath: "spec.username"

              # SSH secret name
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.secretRefName"
                toFieldPath: "spec.secretRefName"

              # destination file path
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.destinationPath"
                toFieldPath: "spec.destinationPath"

              # base64 content
              - type: FromCompositeFieldPath
                fromFieldPath: "spec.sourceInlineBase64"
                toFieldPath: "spec.sourceInlineBase64"
